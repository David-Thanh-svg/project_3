<style>
  /* ===== POST BOX ===== */
  .post-box {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
  }

  .post-box textarea {
      width: 100%;
      border: none;
      resize: none;
      font-size: 15px;
      outline: none;
  }

  .post-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      align-items: center;
  }

  .post-actions select {
      padding: 6px 10px;
      border-radius: 6px;
  }

  .post-actions input[type=file] {
      font-size: 13px;
  }

  .post-actions button {
      background: #1877f2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
  }

  .post-actions button:hover {
      background: #145fd1;
  }

  /* ===== FEED ===== */
  .feed {
      max-width: 600px;
      margin: auto;
  }

  .post-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,.1);
  }

  .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
  }

  .post-header strong {
      margin-left: 8px;
  }

  .post-content {
      margin: 10px 0;
      font-size: 15px;
  }

  .post-media img,
  .post-media video {
      border-radius: 8px;
      margin-top: 8px;
      max-width: 100%;
  }

  /* ===== REPOST ===== */
  .repost-box {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #f9f9f9;
      margin-top: 8px;
  }

</style>


<div class="feed">

  <!-- EDIT MODAL -->
  <div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4)">
    <div style="background:#fff;width:400px;margin:10% auto;padding:20px;border-radius:12px">

      <h3>S·ª≠a b√†i vi·∫øt</h3>

      <form id="editForm" method="post">

      <textarea name="content" id="editContent"
                style="width:100%;height:80px"></textarea>

        <select name="privacy" id="editPrivacy">
          <option value="PUBLIC">C√¥ng khai</option>
          <option value="FRIENDS">B·∫°n b√®</option>
          <option value="PRIVATE">Ch·ªâ m√¨nh t√¥i</option>
        </select>

        <div style="margin-top:10px;text-align:right">
          <button type="button" onclick="closeEdit()">Hu·ª∑</button>
          <button type="submit">L∆∞u</button>
        </div>

      </form>
    </div>
  </div>


  <!-- REPOST MODAL -->
  <div id="repostModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4)">
    <div style="background:#fff;width:400px;margin:10% auto;padding:20px;border-radius:12px">

      <h3>Chia s·∫ª b√†i vi·∫øt</h3>

      <form id="repostForm" method="post">
        <input type="hidden"
               th:name="${_csrf.parameterName}"
               th:value="${_csrf.token}">


        <textarea name="content"
                placeholder="Vi·∫øt g√¨ ƒë√≥..."
                style="width:100%;height:60px"></textarea>

        <div style="margin-top:10px;text-align:right">
          <button type="button" onclick="closeRepost()">Hu·ª∑</button>
          <button type="submit">Chia s·∫ª</button>
        </div>

      </form>
    </div>
  </div>


  <!-- CREATE POST -->
  <form class="post-box"
        th:action="@{/posts/create}"
        method="post"
        enctype="multipart/form-data">

  <textarea name="content"
            placeholder="B·∫°n ƒëang nghƒ© g√¨?"
            required></textarea>

    <!-- TAG -->
    <div style="margin-top:6px">

      <input type="text"
             id="tagSearch"
             placeholder="Tag b·∫°n b√®..."
             autocomplete="off"
             style="width:100%;padding:6px"/>

      <div id="tagResultBox"></div>

      <div id="selectedTags"
           style="margin-top:6px"></div>

      <input type="hidden"
             name="tagUserIds"
             id="tagUserIds"/>

    </div>

    <div class="post-actions">

      <select name="privacy" required>
        <option value="PUBLIC">üåç C√¥ng khai</option>
        <option value="FRIENDS">üë• B·∫°n b√®</option>
        <option value="PRIVATE">üîí Ch·ªâ m√¨nh t√¥i</option>
      </select>

      <input type="file" name="files" multiple/>

      <button type="submit">ƒêƒÉng b√†i</button>
    </div>

  </form>

  <!-- POSTS -->
  <div th:each="post : ${posts}" class="post-card">

    <!-- REPOST PREVIEW -->
    <div th:if="${post.originalPost != null}"
         class="repost-box">

      <strong>üîÅ ƒê√£ chia s·∫ª</strong>

      <div class="repost-inner">

        <strong th:text="${post.originalPost.author.username}"></strong>

        <p th:text="${post.originalPost.content}"></p>

        <!-- MEDIA G·ªêC -->
        <div class="post-media"
             th:each="m : ${post.originalPost.media}">

          <img th:if="${m.type.name() == 'IMAGE'}"
               th:src="${minio.getPresignedUrl(m.mediaPath)}"/>

          <video th:if="${m.type.name() == 'VIDEO'}" controls>
            <source th:src="${minio.getPresignedUrl(m.mediaPath)}"/>
          </video>

        </div>

      </div>
    </div>

    <!-- ACTION -->
    <form th:action="@{/posts/{id}/edit(id=${post.id})}" method="get">
      <button type="submit">‚úè S·ª≠a</button>
    </form>

    <button type="button"
            th:onclick="|openRepost(${post.id})|">
      üîÅ Chia s·∫ª
    </button>
    <form th:action="@{/posts/{id}/delete(id=${post.id})}"
          method="post"
          onsubmit="return confirm('Xo√° b√†i vi·∫øt n√†y?')">

      <input type="hidden"
             th:name="${_csrf.parameterName}"
             th:value="${_csrf.token}"/>

      <button type="submit"
              style="background:#ff4d4d;color:white">
        üóë Xo√°
      </button>
    </form>

    <!-- HEADER -->
    <div class="post-header">
      <strong th:text="${post.author.username}"></strong>
      <span style="margin-left:auto;font-size:12px;color:#777"
            th:text="${#temporals.format(post.createdAt,'HH:mm dd/MM/yyyy')}"></span>
    </div>

    <!-- CONTENT -->
    <div class="post-content"
         th:text="${post.content}">
    </div>

    <!-- MEDIA -->
    <div class="post-media" th:each="m : ${post.media}">
      <img th:if="${m.type.name() == 'IMAGE'}"
           th:src="${minio.getPresignedUrl(m.mediaPath)}"/>

      <video th:if="${m.type.name() == 'VIDEO'}" controls>
        <source th:src="${minio.getPresignedUrl(m.mediaPath)}"/>
      </video>
    </div>

  </div>


  <script>
    function openEdit(id, content, privacy) {
        document.getElementById("editModal").style.display = "block";
        document.getElementById("editContent").value = content;
        document.getElementById("editPrivacy").value = privacy;

        document.getElementById("editForm").action = "/posts/" + id + "/edit";
    }

    function closeEdit() {
        document.getElementById("editModal").style.display = "none";
    }

    function openRepost(id) {
        document.getElementById("repostModal").style.display = "block";
        document.getElementById("repostForm").action = "/posts/" + id + "/repost";
    }

    function closeRepost() {
        document.getElementById("repostModal").style.display = "none";
    }
    let selectedTags = [];

document.getElementById("tagSearch")?.addEventListener("input", async e => {

    let q = e.target.value;
    if (q.length < 2) return;

    let res = await fetch("/users/search?q=" + q);
    let users = await res.json();

    let box = document.getElementById("tagResultBox");
    box.innerHTML = "";

    users.forEach(u => {
        let div = document.createElement("div");
        div.innerText = u.username;
        div.style.cursor = "pointer";
        div.onclick = () => addTag(u.id, u.username);
        box.appendChild(div);
    });
});

function addTag(id, name) {

    if (selectedTags.includes(id)) return;

    selectedTags.push(id);

    let tag = document.createElement("span");
    tag.innerHTML = name + " ‚ùå";
    tag.style.marginRight = "6px";

    tag.onclick = () => {
        selectedTags = selectedTags.filter(x => x !== id);
        tag.remove();
        syncTags();
    };

    document.getElementById("selectedTags").appendChild(tag);
    syncTags();
}

function syncTags() {
    document.getElementById("tagUserIds").value = selectedTags.join(",");
}
    function openEdit(id, content, privacy, tags) {

    document.getElementById("editModal").style.display = "block";

    document.getElementById("editContent").value = content;
    document.getElementById("editPrivacy").value = privacy;

    selectedTags = tags.map(t => t.id);
    syncEditTags(tags);

    document.getElementById("editForm").action =
        "/posts/" + id + "/edit";
}

function syncEditTags(tags) {

    let box = document.getElementById("editTagBox");
    box.innerHTML = "";

    tags.forEach(u => {
        let span = document.createElement("span");
        span.innerHTML = u.username + " ‚ùå";
        span.onclick = () => removeEditTag(u.id);
        box.appendChild(span);
    });

    document.getElementById("editTagIds").value =
        tags.map(t => t.id).join(",");
}

function removeEditTag(id) {
    selectedTags = selectedTags.filter(x => x !== id);
    document.getElementById("editTagIds").value =
        selectedTags.join(",");
}

  </script>

</div>
